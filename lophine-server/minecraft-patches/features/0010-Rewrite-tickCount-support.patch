From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Helvetica Volubi <suisuroru@blue-millennium.fun>
Date: Sun, 28 Sep 2025 13:21:30 +0800
Subject: [PATCH] Rewrite tickCount support


diff --git a/io/papermc/paper/threadedregions/TickRegionScheduler.java b/io/papermc/paper/threadedregions/TickRegionScheduler.java
index b957585cf7cf7f845e20f59c7b355722880f3b4e..9b279d003eb9f780ed2723c98b28d9f4d6e3a281 100644
--- a/io/papermc/paper/threadedregions/TickRegionScheduler.java
+++ b/io/papermc/paper/threadedregions/TickRegionScheduler.java
@@ -412,6 +412,8 @@ public final class TickRegionScheduler {
             }
             // Luminol end - Add tick command support
 
+            MinecraftServer.getServer().handleTickCount(tickCount); // Lophine - reuse tick count
+
             if (!this.tryMarkTicking()) {
                 if (!this.cancelled.get()) {
                     throw new IllegalStateException("Scheduled region should be acquirable");
diff --git a/net/minecraft/server/MinecraftServer.java b/net/minecraft/server/MinecraftServer.java
index b156b5c635f931a3d4abc0584591f90476d011a6..0c2b7aafa8ddee36d38fabd3561e6f97fce828f9 100644
--- a/net/minecraft/server/MinecraftServer.java
+++ b/net/minecraft/server/MinecraftServer.java
@@ -305,6 +305,8 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
 
     // Folia start - regionised ticking
     public final io.papermc.paper.threadedregions.RegionizedServer regionizedServer = new io.papermc.paper.threadedregions.RegionizedServer();
+    private int tickCount; // Lophine - reuse tick count
+    private final ThreadLocal<Integer> lastTickCount = ThreadLocal.withInitial(() -> 0); // Lophine - reuse tick count
 
     @Override
     public <V> CompletableFuture<V> submit(java.util.function.Supplier<V> task) {
@@ -2227,9 +2229,29 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
         return false;
     }
 
+    // Lophine start - reuse tick count
     public int getTickCount() {
-        throw new UnsupportedOperationException(); // Folia - region threading
+        return this.tickCount;
+    }
+
+    public boolean checkTickCount(int period) {
+        return this.checkTickCount(period, this.lastTickCount.get());
+    }
+
+    public boolean checkTickCount(int period, int lastTickCount) {
+        if (this.tickCount % period == 0) {
+            return true;
+        }
+
+        int nextPeriodTick = ((lastTickCount / period) + 1) * period;
+        return nextPeriodTick < this.tickCount;
+    }
+
+    public void handleTickCount(int deltaTicks) {
+        this.lastTickCount.set(this.getTickCount());
+        this.tickCount += deltaTicks;
     }
+    // Lophine end - reuse tick count
 
     public int getSpawnProtectionRadius() {
         return 16;
